- name: Install Evergreen Web Prereqs
  become: true
  shell: >
    cd {{repo_base}}/Evergreen
    && PERL_MM_USE_DEFAULT=1 make -f 
    Open-ILS/src/extras/Makefile.install {{os_build_target}}-developer
- name: Set ownership of {{repo_base}} to {{deploy_user}}
  become: true
  file: dest="{{repo_base}}" owner={{deploy_user}} group={{deploy_user}} recurse=yes
- name: Check if Grunt is used
  stat: path={{repo_base}}/Evergreen/Open-ILS/web/js/ui/default/staff/Gruntfile.js
  register: gruntfile_result
- name: Install Grunt
  become: true
  npm: name=grunt-cli global=true
  when: gruntfile_result.stat.exists
- name: Node Build
  become: true
  npm: path={{repo_base}}/Evergreen/Open-ILS/web/js/ui/default/staff
- name: Grunt Build
  shell: >
    cd {{repo_base}}/Evergreen/Open-ILS/web/js/ui/default/staff
    && grunt build
  when: gruntfile_result.stat.exists
- name: Grunt Test
  shell: >
    cd {{repo_base}}/Evergreen/Open-ILS/web/js/ui/default/staff
    && grunt test
  when: gruntfile_result.stat.exists
- name: npm build
  shell: >
    cd {{repo_base}}/Evergreen/Open-ILS/web/js/ui/default/staff 
    && npm run build-prod
  when: gruntfile_result.stat.exists == False
- name: npm test
  shell: >
    cd {{repo_base}}/Evergreen/Open-ILS/web/js/ui/default/staff 
    && npm run test
  when: gruntfile_result.stat.exists == False
